---
title: "Cyrius Post-Run Report"
author:
  - "Lightning Auriga"
date: "`r format(Sys.time(), '%d %B, %Y')`"
params:
  rmd: "cyrius.Rmd"
output:
  html_document:
    code_folding: "hide"
    highlight: tango
    number_sections: no
    theme: default
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: no
      smooth_scroll: yes
---

```{r load.packages, eval=TRUE, echo=FALSE}
## Load required R packages

require(knitr, quietly = TRUE)
require(kableExtra, quietly = TRUE)
require(ggplot2, quietly = TRUE)
require(RColorBrewer, quietly = TRUE)
require(stringr, quietly = TRUE)
require(DescTools, quietly = TRUE)
```

```{r set.ggplot2.theme, eval=TRUE, echo=TRUE}
## Configure standard theme information for ggplot2

my.theme <- theme_light() + theme(
  plot.title = element_text(size = 15, hjust = 0.5),
  axis.title = element_text(size = 14),
  axis.text = element_text(size = 12),
  strip.background = element_blank(),
  strip.text = element_text(size = 14, colour = "black")
)
```

```{r set.variables, eval=TRUE, echo=TRUE}
## Set input variables from snakemake
cyrius.tsv <- snakemake@input[["results"]]
cyrius.published.table <- snakemake@input[["pubtable"]]
```

```{r sanitize.asterisks.function, eval=TRUE, echo=FALSE}
sanitize.asterisks <- function(vec) {
  stringr::str_replace_all(vec, "\\*", "\\\\*")
}
```

```{r load.cyrius.table, eval=TRUE, echo=TRUE}
cyrius.data <- read.table(cyrius.tsv, header = TRUE, sep = "\t", stringsAsFactors = FALSE)
cyrius.table.data <- cyrius.data
cyrius.table.data[, 2] <- sanitize.asterisks(cyrius.table.data[, 2])
na12878.present <- length(which(cyrius.table.data[, 1] == "NA12878")) > 0
```


```{r initialize.known.counts, eval=TRUE, echo=FALSE}
cyrius.published.data <- read.table(cyrius.published.table,
  header = TRUE,
  sep = "\t", stringsAsFactors = FALSE,
  check.names = FALSE
)
cyrius.published.data <- cyrius.published.data[, 1:7]
```

### Haplotype Call Summary Metrics

```{r report.basic.summary.metrics, eval=TRUE, echo=FALSE, results="asis"}
calls <- c(
  "PASS",
  "More_than_one_possible_genotype",
  "Not_assigned_to_haplotypes",
  "LowQ_high_CN",
  "None",
  "[combined]"
)
counts <- c(
  length(which(cyrius.data[, 3] == calls[1])),
  length(which(cyrius.data[, 3] == calls[2])),
  length(which(cyrius.data[, 3] == calls[3])),
  length(which(cyrius.data[, 3] == calls[4])),
  length(which(cyrius.data[, 3] == calls[5])),
  nrow(cyrius.data)
)
metric.data <- data.frame(
  Call = calls,
  Count = counts
)
knitr::kable(metric.data, caption = "Haplotype Call Summary Metrics") %>%
  kableExtra::kable_styling("condensed", position = "left", full_width = FALSE)
```

`r if (na12878.present) {"### Positive Control Report"}`

`r if (na12878.present) {cat("Per [this paper](https://www.nature.com/articles/s41397-020-00205-5),",
                             "the expected haplotype call for NA12878 is \\*3/\\*68+\\*4.")}`

```{r positive.control.report, eval=na12878.present, echo=FALSE, results="asis"}
knitr::kable(cyrius.table.data[cyrius.table.data[, 1] == "NA12878", ],
  caption = "Positive Control Results for Cyrius"
) %>%
  kableExtra::kable_styling("condensed", position = "left", full_width = FALSE)
```


### Haplotype Frequencies versus 1KG

The following table recapitulates the contents of [Table 2 of the Cyrius paper](https://doi.org/10.1038/s41397-020-00205-5),
adding an additional column representing the corresponding haplotype frequency data from the current subject set.

```{r annotate.counts.from.dataset, eval=TRUE, echo=FALSE}
cyrius.published.data$"This dataset" <- rep(0, nrow(cyrius.published.data))
for (i in seq_len(nrow(cyrius.data))) {
  if (cyrius.data[i, 3] == "PASS") {
    gtype1 <- stringr::str_replace(cyrius.data[i, 2], "^([^/]+)/.*$", "\\1")
    gtype2 <- stringr::str_replace(cyrius.data[i, 2], "^[^/]+/(.*)$", "\\1")
    update.count <- function(gtype) {
      res <- cyrius.published.data$"This dataset"
      if (length(which(cyrius.published.data[, 1] == gtype)) == 1) {
        res[cyrius.published.data[, 1] == gtype] <-
          cyrius.published.data$"This dataset"[cyrius.published.data[, 1] == gtype] + 1
      } else {
        res[cyrius.published.data[, 1] == "Unknown"] <-
          cyrius.published.data$"This dataset"[cyrius.published.data[, 1] == "Unknown"] + 1
      }
      res
    }
    cyrius.published.data$"This dataset" <- update.count(gtype1)
    cyrius.published.data$"This dataset" <- update.count(gtype2)
  } # else if (cyrius.data[i, 3] == "More_than_one_possible_genotype") {
  ##
  ## } else if (cyrius.data[i, 3] == "Not_assigned_to_haplotypes") {
  ##
  ## } # else cyrius.data[i, 3] == "LowQ_high_CN"
}
cyrius.published.data[, 1] <- sanitize.asterisks(cyrius.published.data[, 1])
multi.cis <- DescTools::MultinomCI(cyrius.published.data$"This dataset")
cyrius.published.data$"This dataset" <- round(multi.cis[, 1] * 100, 2)
cyrius.published.data$"95% CI" <- paste("[", round(multi.cis[, 2] * 100, 2), ", ",
  round(multi.cis[, 3] * 100, 2), "]",
  sep = ""
)
cyrius.published.data$"This dataset"[nrow(cyrius.published.data)] <- NA
```

```{r report.counts.from.dataset, eval=TRUE, echo=FALSE, results="asis"}
knitr::kable(cyrius.published.data,
  caption = "https://doi.org/10.1038/s41397-020-00205-5 Table 2 with Current Cyrius Results"
) %>%
  kableExtra::kable_styling("condensed", position = "left", full_width = FALSE)
```

```{r paired.barplot, eval=TRUE, echo=FALSE}
```

### Full Haplotyping Results for All Subjects

```{r report.summary.table, eval=TRUE, echo=FALSE, results="asis"}
knitr::kable(cyrius.table.data, caption = "Current Results from Cyrius") %>%
  kableExtra::kable_styling("condensed", position = "left", full_width = FALSE)
```


***
<br>

## Assorted Software Links

<br>

- [Cyrius](https://github.com/Illumina/Cyrius)

***
<br>

## Session Information

<br>

The following summarizes the loaded R configuration for the run that created this report.

```{r session.info, eval=TRUE, echo=TRUE}
sessionInfo()
```
